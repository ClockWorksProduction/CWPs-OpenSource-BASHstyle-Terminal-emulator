
name: Publish to npm

on:
  push:
    tags:
      - 'v*.*.*' # Trigger on tags like v1.0.0
  schedule:
    # Run on the 1st and 15th of every month at midnight UTC
    - cron: '0 0 1,15 * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # Specify your node version
          registry-url: 'https://registry.npmjs.org/'

      - name: Install dependencies
        run: npm ci

      # Optional: Add a build step if you have one
      # - name: Build project
      #   run: npm run build

      - name: Determine Version and NPM Tag
        id: get_version
        run: |
          if [[ $GITHUB_EVENT_NAME == 'push' && $GITHUB_REF_TYPE == 'tag' ]]; then
            # Stable release from git tag
            VERSION=${GITHUB_REF_NAME#v}
            NPM_TAG=latest
            echo "Publishing stable release: $VERSION"
          elif [[ $GITHUB_EVENT_NAME == 'schedule' ]]; then
            # Bi-weekly release, tagged as 'nightly'
            BASE_VERSION=$(node -p "require('./package.json').version")
            # Using date for versioning to ensure uniqueness
            VERSION="$BASE_VERSION-nightly.$(date +%Y%m%d)"
            NPM_TAG=nightly
            echo "Bumping version to $VERSION for bi-weekly release"
            npm version $VERSION --no-git-tag-version
            echo "Publishing bi-weekly release with tag 'nightly': $VERSION"
          else
            # Manual dev release
            BASE_VERSION=$(node -p "require('./package.json').version")
            VERSION="$BASE_VERSION-dev.$(date +%s)"
            NPM_TAG=dev
            echo "Bumping version to $VERSION for dev release"
            npm version $VERSION --no-git-tag-version
            echo "Publishing dev release: $VERSION"
          fi
          echo "NPM_TAG=$NPM_TAG" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Publish to npm
        run: npm publish --tag ${{ env.NPM_TAG }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
